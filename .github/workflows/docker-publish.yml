name: Docker Build and Push

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps: # Êìç‰ΩúÁöÑÊ≠•È™§
      - name: Checkout code # ÂêçÁß∞
        uses: actions/checkout@v2

      - name: Log in to Alibaba Cloud Container Registry # ÁôªÂΩïÂà∞ÈòøÈáå‰∫ëÁöÑÂÆπÂô®
        env: # ÁéØÂ¢ÉÂèòÈáè
          ALIYUN_REGISTRY: registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}  # ‰ΩøÁî® GitHub Secrets Â≠òÂÇ®ÈòøÈáå‰∫ëÁî®Êà∑Âêç
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}  # ‰ΩøÁî® GitHub Secrets Â≠òÂÇ®ÈòøÈáå‰∫ëÂØÜÁ†Å
        run: | # ‰ΩøÁî®ÂëΩ‰ª§Ë°åÁöÑÁôªÂΩï
          echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login --username "${{ secrets.ALIYUN_USERNAME }}" --password-stdin $ALIYUN_REGISTRY

      - name: Build Docker image # ‰ª£Á†ÅÊâìÂåÖ  ÂëΩ‰ª§Ë°åÂàõÂª∫ÔºåÈúÄË¶ÅË∑ØÂæÑ
        id: build
        run: | 
          IMAGE_NAME="registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management"
          BUILD_VERSION=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          GIT_COMMIT=$(git rev-parse --short HEAD)
          TIMESTAMP_TAG=$(date +'%Y%m%d%H%M')
          docker build \
            --build-arg BUILD_VERSION="${BUILD_VERSION}" \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg GIT_COMMIT="${GIT_COMMIT}" \
            -t "${IMAGE_NAME}:latest" \
            -t "${IMAGE_NAME}:${TIMESTAMP_TAG}" \
            -f Dockerfile . 
          echo "timestamp_tag_=${TIMESTAMP_TAG}" >> $GITHUB_OUTPUT

      - name: Push Docker image # ‰ª£Á†ÅPush 
        run: |
          IMAGE_NAME="registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management"
          docker push "${IMAGE_NAME}:latest"
          docker push "${IMAGE_NAME}:${{ steps.build.outputs.timestamp_tag }}"

      - name: Upload logs on failure
        if: ${{ failure() }}
        run: |
          # Encode the message to handle emojis and special characters
          MESSAGE="‚ùå${{ github.repository }} actions redeployed failure ‚ùå"
          ENCODED_MESSAGE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$MESSAGE'))")
          
          curl -L "https://api.day.app/ogSVMSaU6XHBXx9dt9j4Sm/$ENCODED_MESSAGE"

  redeploy:
    needs: build-and-push
    runs-on: self-hosted
    steps: # Êìç‰ΩúÁöÑÊ≠•È™§
      - name: Inspect Runner File System
        env:
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
        run: |
          echo "--- ÂΩìÂâçÂ∑•‰ΩúÁõÆÂΩï (pwd) ---"
          bash /runner/psd_project_manager/redeploy.sh

      - name: Push to iPhone
        run: curl -L "https://api.day.app/ogSVMSaU6XHBXx9dt9j4Sm/üéâ${{ github.repository }}/actions redeployed successfully! "