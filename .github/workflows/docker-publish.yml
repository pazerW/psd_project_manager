name: Docker Build and Push

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # 允许手动触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Alibaba Cloud Container Registry
        if: github.event_name != 'pull_request'
        env:
          ACR_REGION: ${{ secrets.ACR_REGION || 'cn-hangzhou' }}
          ACR_REGISTRY: registry.${{ secrets.ACR_REGION || 'cn-hangzhou' }}.aliyuncs.com
          ACR_USERNAME: ${{ secrets.ACR_ACCESS_KEY_ID }}
          ACR_PASSWORD: ${{ secrets.ACR_ACCESS_KEY_SECRET }}
        run: |
          echo "$ACR_PASSWORD" | docker login --username "$ACR_USERNAME" --password-stdin $ACR_REGISTRY
        continue-on-error: true

      - name: Build and Push Docker image
        if: github.event_name != 'pull_request'
        env:
          ACR_REGION: ${{ secrets.ACR_REGION || 'cn-hangzhou' }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE || 'default-namespace' }}
          IMAGE_NAME: design_project_management
        run: |
          REGISTRY="registry.${ACR_REGION}.aliyuncs.com"
          FULL_IMAGE_NAME="${REGISTRY}/${ACR_NAMESPACE}/${IMAGE_NAME}"
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          RUN_NUMBER="${{ github.run_number }}"
          COMMIT_SHA="${{ github.sha }}"
          
          echo "构建镜像..."
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            -t "${FULL_IMAGE_NAME}:latest" \
            -t "${FULL_IMAGE_NAME}:${TIMESTAMP}" \
            -t "${FULL_IMAGE_NAME}:${RUN_NUMBER}" \
            -t "${FULL_IMAGE_NAME}:${COMMIT_SHA}" \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg VCS_REF="${COMMIT_SHA}" \
            .
          
          echo "✓ 镜像构建并推送成功"
          echo "镜像标签："
          echo "  - ${FULL_IMAGE_NAME}:latest"
          echo "  - ${FULL_IMAGE_NAME}:${TIMESTAMP}"
          echo "  - ${FULL_IMAGE_NAME}:${RUN_NUMBER}"
          echo "  - ${FULL_IMAGE_NAME}:${COMMIT_SHA}"

      - name: Build only (for PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "PR 构建 - 仅构建镜像，不推送"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t design_project_management:pr-${{ github.event.pull_request.number }} \
            .