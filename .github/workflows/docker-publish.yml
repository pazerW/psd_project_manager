name: Docker Build and Push

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps: # æ“ä½œçš„æ­¥éª¤
      - name: Checkout code # åç§°
        uses: actions/checkout@v2

      - name: Log in to Alibaba Cloud Container Registry # ç™»å½•åˆ°é˜¿é‡Œäº‘çš„å®¹å™¨
        env: # ç¯å¢ƒå˜é‡
          ALIYUN_REGISTRY: registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}  # ä½¿ç”¨ GitHub Secrets å­˜å‚¨é˜¿é‡Œäº‘ç”¨æˆ·å
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}  # ä½¿ç”¨ GitHub Secrets å­˜å‚¨é˜¿é‡Œäº‘å¯†ç 
        run: | # ä½¿ç”¨å‘½ä»¤è¡Œçš„ç™»å½•
          echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login --username "${{ secrets.ALIYUN_USERNAME }}" --password-stdin $ALIYUN_REGISTRY

      - name: Build Docker image # ä»£ç æ‰“åŒ…  å‘½ä»¤è¡Œåˆ›å»ºï¼Œéœ€è¦è·¯å¾„
        id: build
        run: | 
          IMAGE_NAME="registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management"
          BUILD_VERSION=$(date +'%Y-%m-%d %H:%M:%S')
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          GIT_COMMIT=$(git rev-parse --short HEAD)
          TIMESTAMP_TAG=$(date +'%Y%m%d%H%M')
          docker build \
            --build-arg BUILD_VERSION="${BUILD_VERSION}" \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg GIT_COMMIT="${GIT_COMMIT}" \
            -t "${IMAGE_NAME}:latest" \
            -t "${IMAGE_NAME}:${TIMESTAMP_TAG}" \
            -f Dockerfile . 

      - name: Push Docker image # ä»£ç Push 
        run: |
          IMAGE_NAME="registry.cn-beijing.aliyuncs.com/pazerwong/design_project_management"
          docker push "${IMAGE_NAME}:latest"
          docker push "${IMAGE_NAME}:${{ steps.build.outputs.timestamp_tag }}"

      - name: Upload logs on failure
        if: ${{ failure() }}
        run: curl -L "https://api.day.app/ogSVMSaU6XHBXx9dt9j4Sm/ âŒ${{ github.repository }}/actions redeployed failure âŒ"

  redeploy:
    needs: build-and-push
    runs-on: self-hosted
    steps: # æ“ä½œçš„æ­¥éª¤
      - name: Inspect Runner File System
        env:
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
        run: |
          echo "--- å½“å‰å·¥ä½œç›®å½• (pwd) ---"
          bash /runner/psd_project_manager/redeploy.sh

      - name: Push to iPhone
        run: curl -L "https://api.day.app/ogSVMSaU6XHBXx9dt9j4Sm/ğŸ‰${{ github.repository }}/actions redeployed successfully! "